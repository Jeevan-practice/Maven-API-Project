---
- name: Download artifact from S3 and deploy to Tomcat
  hosts: tomcat_servers
  become: yes
  vars:
    s3_bucket: "maven-artifacts-9964"
    s3_object: "*.war"
    local_path: "/tmp/artifact.war"
    tomcat_webapps: "/opt/tomcat/webapps"
    aws_region: "ap-south-2"

  tasks:
   
    - name: Download artifact from S3
      command: >
        aws s3 cp s3://{{ s3_bucket }}/{{ s3_object }} {{ local_path }}
        --region {{ aws_region }}
      
    - name: Stop Tomcat service
      service:
        name: tomcat
        state: stopped

    - name: Remove old artifact
      file:
        path: "{{ tomcat_webapps }}/artifact.war"
        state: absent

    - name: Copy new artifact to Tomcat webapps
      copy:
        src: "{{ local_path }}"
        dest: "{{ tomcat_webapps }}/artifact.war"
        owner: tomcat
        group: tomcat
        mode: '0644'

    - name: Start Tomcat service
      service:
        name: tomcat
        state: started
